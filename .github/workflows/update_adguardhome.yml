name: Update Adguardhome

on:
  workflow_dispatch:
  schedule:
    - cron: 30 21 * * *

env:
  URL: https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest

jobs:
  update:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@main

    - name: Set git identity
      run : |
        git config --local user.name "actions"
        git config --local user.email "action@github.com"

    - name: Check up Adguardhome
      run: |
        echo "LOCAL_VER=$(grep "PKG_VERSION:=" $GITHUB_WORKSPACE/adguardhome/Makefile | grep -oE "[0-9.]+")" >> $GITHUB_ENV
        echo "CLOUD_VER=$(curl -L -o - ${{ env.URL }} 2>/dev/null|grep -E 'tag_name' |grep -oE "[0-9.]+" 2>/dev/null)" >> $GITHUB_ENV
        echo -e "Adguardhome Local version: v$LOCAL_VER, cloud version: v$CLOUD_VER" 
        sed -i "s/PKG_VERSION:=.*/PKG_VERSION:=$CLOUD_VER/g" $GITHUB_WORKSPACE/adguardhome/Makefile

    - name: Push Commits
      if: env.CLOUD_VER != env.LOCAL_VER
      run: |
        git add $GITHUB_WORKSPACE/adguardhome/Makefile
        git commit -m "Update Adguardhome ${{ env.CLOUD_VER }}"
        git push
